# 系统测试用例

## 测试环境准备

1. 安装Node.js（v18或更高版本）
2. 运行 `test-api.bat` 启动后端服务
3. 确保数据库已初始化（包含测试数据）

## 测试用例

### TC001: 用户登录

**测试目标**: 验证用户登录功能

**测试步骤**:
1. 使用正确的用户名和密码登录
2. 使用错误的用户名或密码登录
3. 使用被禁用的账号登录

**测试数据**:
```
正确: username="doc001", password="123456"
错误: username="doc001", password="wrongpwd"
禁用: username="therapist002", password="123456"
```

**预期结果**:
- 正确登录：返回access_token和用户信息
- 错误登录：返回401 Unauthorized
- 禁用账号：返回401 Unauthorized

**API调用**:
```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"doc001","password":"123456"}'
```

---

### TC002: 角色权限控制

**测试目标**: 验证不同角色看到的可操作项目不同

**测试步骤**:
1. 医师登录，获取可操作项目
2. 护士登录，获取可操作项目
3. 治疗师登录，获取可操作项目

**预期结果**:
- 医师看到：针灸治疗
- 护士看到：电刺激治疗
- 治疗师看到：运动功能训练、生活技能康复训练、认知功能训练、言语功能训练、职业功能康复训练

**API调用**:
```bash
# 获取token后
curl -X GET http://localhost:3000/projects/my \
  -H "Authorization: Bearer TOKEN"
```

---

### TC003: 患者搜索 - 病历号后3位

**测试目标**: 验证病历号后3位搜索功能

**测试步骤**:
1. 输入"321"搜索
2. 输入"322"搜索
3. 输入"999"搜索（不存在的病历号）

**预期结果**:
- "321": 返回病历号150321的患者（王建国）
- "322": 返回病历号150322的患者（李秀英）
- "999": 返回空数组

**API调用**:
```bash
curl -X GET "http://localhost:3000/patients/search?q=321" \
  -H "Authorization: Bearer TOKEN"
```

---

### TC004: 患者搜索 - 拼音首字母

**测试目标**: 验证拼音首字母搜索功能

**测试步骤**:
1. 输入"wjg"搜索
2. 输入"lxy"搜索
3. 输入"xyz"搜索（不存在的拼音）

**预期结果**:
- "wjg": 返回"王建国"
- "lxy": 返回"李秀英"
- "xyz": 返回空数组

**API调用**:
```bash
curl -X GET "http://localhost:3000/patients/search?q=wjg" \
  -H "Authorization: Bearer TOKEN"
```

---

### TC005: 创建治疗记录

**测试目标**: 验证治疗记录创建和自动计算功能

**测试步骤**:
1. 创建一条治疗记录（不指定结束时间）
2. 查看返回的记录，检查结束时间是否自动计算
3. 检查照片文件名是否自动生成

**测试数据**:
```json
{
  "patientId": 1,
  "projectId": 1,
  "treatmentDate": "2024-01-10T14:30:00Z",
  "startTime": "2024-01-10T14:30:00Z"
}
```

**预期结果**:
- 记录创建成功
- endTime = startTime + 30分钟 + 随机60-120秒
- photoFileName = "150321_001.jpg"
- outcome = "无不良反应"

**API调用**:
```bash
curl -X POST http://localhost:3000/records \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "patientId": 1,
    "projectId": 1,
    "treatmentDate": "2024-01-10T14:30:00Z",
    "startTime": "2024-01-10T14:30:00Z"
  }'
```

---

### TC006: 用户管理 - 创建用户

**测试目标**: 验证管理员创建新用户功能（需要admin账号）

**测试步骤**:
1. 使用管理员token创建新用户
2. 查看用户列表，确认新用户已创建
3. 使用新用户登录

**测试数据**:
```json
{
  "username": "doc002",
  "password": "123456",
  "name": "李医生",
  "role": "physician",
  "department": "康复科"
}
```

**预期结果**:
- 用户创建成功
- 新用户出现在用户列表中
- 可以使用新账号登录

**API调用**:
```bash
curl -X POST http://localhost:3000/users \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "doc002",
    "password": "123456",
    "name": "李医生",
    "role": "physician",
    "department": "康复科"
  }'
```

---

### TC007: 用户管理 - 重置密码

**测试目标**: 验证密码重置功能

**测试步骤**:
1. 重置指定用户的密码
2. 使用新密码登录

**预期结果**:
- 密码重置成功
- 可以使用新密码登录

**API调用**:
```bash
curl -X POST http://localhost:3000/users/2/password \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"newPassword":"654321"}'
```

---

### TC008: 用户管理 - 切换用户状态

**测试目标**: 验证启用/禁用用户功能

**测试步骤**:
1. 禁用一个用户
2. 尝试使用被禁用用户登录
3. 重新启用该用户
4. 再次尝试登录

**预期结果**:
- 禁用后无法登录
- 启用后可以登录

**API调用**:
```bash
# 禁用用户
curl -X PUT http://localhost:3000/users/5/status \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 尝试登录（应该失败）
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"therapist002","password":"123456"}'

# 重新启用
curl -X PUT http://localhost:3000/users/5/status \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

---

### TC009: 治疗记录更新

**测试目标**: 验证可以修改记录的所有字段

**测试步骤**:
1. 创建一条治疗记录
2. 修改记录的患者、项目、时间、反应、备注
3. 查看更新后的记录

**预期结果**:
- 所有字段都可以修改成功

**API调用**:
```bash
curl -X PUT http://localhost:3000/records/1 \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "patientId": 2,
    "projectId": 2,
    "outcome": "轻微疲劳",
    "notes": "治疗后有轻微疲劳感"
  }'
```

---

### TC010: 治疗统计

**测试目标**: 验证统计数据计算正确性

**测试步骤**:
1. 创建多条治疗记录
2. 按日期范围查询统计
3. 检查项目统计和治疗师统计

**预期结果**:
- 返回总记录数
- 返回按项目分组的统计
- 返回按治疗师分组的统计

**API调用**:
```bash
curl -X GET "http://localhost:3000/records/statistics?startDate=2024-01-01&endDate=2024-12-31" \
  -H "Authorization: Bearer TOKEN"
```

---

## 自动化测试脚本

### Postman Collection

可以导入Postman进行自动化测试：

```json
{
  "info": {
    "name": "康复科系统API测试",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "登录",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\"username\":\"doc001\",\"password\":\"123456\"}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "http://localhost:3000/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["auth", "login"]
        }
      }
    }
  ]
}
```

---

## 测试报告模板

### 测试执行记录

| 测试用例 | 执行日期 | 执行人 | 测试结果 | 备注 |
|---------|---------|--------|---------|------|
| TC001 | | | ☐ 通过 ☐ 失败 | |
| TC002 | | | ☐ 通过 ☐ 失败 | |
| TC003 | | | ☐ 通过 ☐ 失败 | |
| TC004 | | | ☐ 通过 ☐ 失败 | |
| TC005 | | | ☐ 通过 ☐ 失败 | |
| TC006 | | | ☐ 通过 ☐ 失败 | |
| TC007 | | | ☐ 通过 ☐ 失败 | |
| TC008 | | | ☐ 通过 ☐ 失败 | |
| TC009 | | | ☐ 通过 ☐ 失败 | |
| TC010 | | | ☐ 通过 ☐ 失败 | |

### 缺陷记录

| 缺陷ID | 标题 | 严重程度 | 状态 | 发现日期 |
|--------|------|---------|------|---------|
| BUG001 | | ☐ 高 ☐ 中 ☐ 低 | ☐ 待修复 ☐ 已修复 | |
| BUG002 | | ☐ 高 ☐ 中 ☐ 低 | ☐ 待修复 ☐ 已修复 | |

---

## 性能测试

### 响应时间要求

- 用户登录: < 500ms
- 患者搜索: < 300ms
- 获取项目列表: < 200ms
- 创建治疗记录: < 500ms
- 统计查询: < 1000ms

### 并发测试

使用Apache Bench进行压力测试：

```bash
# 测试登录接口（100并发，共1000次请求）
ab -n 1000 -c 100 -p login.json -T application/json http://localhost:3000/auth/login
```

login.json:
```json
{"username":"doc001","password":"123456"}
```

---

## 安全测试

### SQL注入测试

```bash
# 在搜索接口尝试SQL注入
curl -X GET "http://localhost:3000/patients/search?q=' OR '1'='1" \
  -H "Authorization: Bearer TOKEN"
```

**预期结果**: 应该被安全处理，不返回错误或泄露数据

### 未授权访问测试

```bash
# 尝试不提供token访问受保护资源
curl -X GET http://localhost:3000/users
```

**预期结果**: 返回401 Unauthorized

### 权限提升测试

```bash
# 使用普通用户token尝试访问管理员接口
curl -X POST http://localhost:3000/users \
  -H "Authorization: Bearer USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'
```

**预期结果**: 返回403 Forbidden
