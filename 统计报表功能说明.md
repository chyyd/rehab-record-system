# 统计报表功能说明

## 功能概述

统计报表模块提供了强大的数据统计分析功能，支持多种日期范围快速选择，帮助医护人员和管理者快速了解治疗工作情况。

## 核心功能

### 1. 日期范围快速选择

支持5种预设日期范围，一键切换：

| 快速选项 | 说明 | 时间范围 |
|---------|------|---------|
| **今日** | 当天完整日期 | 今天 00:00 - 今天 23:59 |
| **本周** | 周一至周日 | 本周一 00:00 - 本周日 23:59 |
| **本月** | 自然月 | 本月1日 00:00 - 本月最后一日 23:59 |
| **本账期** | 医保账期 | 上月21日 - 本月20日 或 本月21日 - 下月20日 |
| **本年** | 自然年 | 本年1月1日 00:00 - 本年12月31日 23:59 |

### 2. 智能账期计算

**账期规则：** 每月21日0点至次月20日23点59分

**自动判断逻辑：**
- 如果当前日期 ≥ 21日：账期为 **本月21日 - 下月20日**
- 如果当前日期 < 21日：账期为 **上月21日 - 本月20日**

**示例：**
```
今天是1月25日 → 账期为 1月21日 - 2月20日
今天是1月15日 → 账期为 12月21日 - 1月20日
```

### 3. 自定义日期范围

- 支持手动选择任意日期范围
- 选择自定义范围后，快速选择标记自动清除
- 日期格式：YYYY-MM-DD

### 4. 统计指标

#### 4.1 总览指标（4个统计卡片）

| 指标 | 说明 | 计算 |
|------|------|------|
| 总治疗人次 | 选中时间段内的治疗记录总数 | COUNT(*) |
| 总治疗时长(小时) | 所有治疗记录的时长总和 | SUM(时长) / 60 |
| 治疗患者数 | 不重复的患者数量 | COUNT(DISTINCT patient_id) |
| 活跃治疗师 | 不重复的治疗师数量 | COUNT(DISTINCT therapist_id) |

#### 4.2 按项目统计

- 项目名称
- 治疗次数
- 占比（百分比）

#### 4.3 治疗师工作量

- 治疗师姓名
- 治疗次数
- 工作时长（小时）

#### 4.4 患者治疗统计

- 患者姓名
- 病历号
- 治疗次数
- 总时长（小时）
- 参与项目（多个项目用顿号分隔）

## 使用流程

### 标准使用流程

1. **选择日期范围**
   - 点击快速选择按钮（推荐）
   - 或手动选择自定义日期范围

2. **点击查询**
   - 快速选择：自动加载数据
   - 自定义范围：需手动点击"查询"按钮

3. **查看统计数据**
   - 顶部4个统计卡片显示总览数据
   - 下方3个表格显示详细分类统计

4. **重置**
   - 点击"重置"按钮恢复默认（本月）

### 高级使用技巧

#### 技巧1：快速对比不同时间段

```
步骤：
1. 选择"本月"查看本月数据
2. 选择"本账期"对比账期数据
3. 选择"本年"查看年度累计
```

#### 技巧2：自定义日期范围分析

```
场景：分析某一周的治疗情况
1. 点击"自定义范围"日期选择器
2. 选择开始日期（周一）
3. 选择结束日期（周日）
4. 点击"查询"按钮
```

#### 技巧3：导出数据

```
1. 选择需要的日期范围
2. 查询数据
3. 使用浏览器打印功能（Ctrl+P）
4. 选择"保存为PDF"导出报表
```

## 界面设计特点

### 1. 现代化UI设计

- **渐变色统计卡片**：4种不同渐变色主题
  - 紫色渐变：总治疗人次
  - 粉红渐变：总治疗时长
  - 蓝色渐变：治疗患者数
  - 绿色渐变：活跃治疗师

- **图标+数值布局**：更直观的数据展示
- **悬停效果**：卡片悬停时轻微上浮，增强交互感

### 2. 智能提示

- **日期范围信息栏**：显示当前统计的时间范围
- **类型标签**：显示选择的日期类型（今日/本周/本月等）
- **加载状态**：查询按钮显示加载动画

### 3. 响应式设计

- **桌面端**：4列统计卡片布局
- **平板端**：2列统计卡片布局
- **移动端**：单列统计卡片，按钮组自动换行

## 技术实现

### 前端技术栈

- **Vue 3 Composition API**：响应式数据管理
- **Element Plus**：UI组件库
- **Day.js**：日期处理库（轻量级）
- **SCSS**：样式预处理器

### 核心算法

#### 账期计算逻辑

```typescript
case 'billing':
  const currentDay = today.date()
  if (currentDay >= 21) {
    // 当前日期在21日之后，账期为本月21日至下月20日
    startDate = today.date(21).startOf('day')
    endDate = today.add(1, 'month').date(20).endOf('day')
  } else {
    // 当前日期在20日之前，账期为上月21日至本月20日
    startDate = today.subtract(1, 'month').date(21).startOf('day')
    endDate = today.date(20).endOf('day')
  }
  break
```

### 性能优化

- **自动加载**：快速选择后自动触发查询，减少点击次数
- **加载状态**：防止重复提交，提升用户体验
- **前端计算**：统计数据在前端计算，减少后端压力

## 数据来源

所有统计数据来自治疗记录表（`TreatmentRecord`），包括：

- 治疗时间（`treatmentDate`）
- 治疗时长（`durationMinutes`）
- 患者ID（`patientId`）
- 治疗师ID（`therapistId`）
- 项目ID（`projectId`）

## 常见问题

### Q1: 为什么"本账期"的日期范围和我预期的不一样？

**A:** 账期采用医保规则：每月21日至次月20日。系统会根据当前日期自动判断属于哪个账期。

### Q2: 自定义日期范围后为什么不自动加载数据？

**A:** 为避免频繁查询，自定义日期范围需要手动点击"查询"按钮。快速选择选项会自动加载。

### Q3: 如何导出统计数据？

**A:** 目前支持通过浏览器打印功能导出为PDF。后续版本会增加专门的导出功能。

### Q4: 统计数据为什么是0？

**A:** 请检查：
1. 选择的日期范围内是否有治疗记录
2. 数据库连接是否正常
3. 打开浏览器控制台查看是否有错误信息

## 未来规划

- [ ] 增加数据导出功能（Excel/PDF）
- [ ] 增加图表可视化（柱状图、饼图、折线图）
- [ ] 支持多维度交叉分析
- [ ] 增加同比/环比分析
- [ ] 支持自定义报表模板
- [ ] 增加数据趋势预测

## 更新日志

### v1.2.0 (2026-01-16)

- ✨ 新增快速日期选择功能（今日、本周、本月、本账期、本年）
- ✨ 智能账期计算逻辑
- 🎨 全新的统计卡片UI设计
- 🎨 优化表格样式和交互
- 📱 响应式设计支持移动端
- ⚡ 性能优化和用户体验提升

---

**最后更新时间：** 2026年1月16日
