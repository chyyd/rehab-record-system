# æ‰‹æœºç«¯åŠŸèƒ½å¼€å‘è®¡åˆ’

## ğŸ“… é¡¹ç›®æ¦‚è¿°

**å¼€å‘æ¨¡å¼ï¼š** æ¸è¿›å¼å¼€å‘ï¼ˆåˆ†é˜¶æ®µå®æ–½ï¼‰
**ç›®æ ‡ï¼š** ä¸ºæ‰‹æœºç«¯æ–°å¢æ‚£è€…ç®¡ç†ã€å‡ºé™¢æ“ä½œã€å¿«æ·é¡¹ç›®å’Œæ—¶é—´éªŒè¯åŠŸèƒ½
**å¼€å‘å‘¨æœŸï¼š** é¢„è®¡3ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µç‹¬ç«‹æµ‹è¯•å’Œä¸Šçº¿

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- âœ… æ—¶é—´å†²çªéªŒè¯ - é˜²æ­¢åŒä¸€æ‚£è€…æ—¶é—´é‡å è®°å½•
- âœ… å¿«æ·é¡¹ç›®é€‰æ‹© - æ˜¾ç¤ºæœ€è¿‘7å¤©å¸¸é©»é¡¹ç›®ï¼ˆ3ä¸ªï¼‰
- âœ… æ–°å¢æ‚£è€…åŠŸèƒ½ - æ‰‹æœºç«¯ç›´æ¥åˆ›å»ºæ‚£è€…æ¡£æ¡ˆ

### é‡è¦åŠŸèƒ½
- âœ… æ‚£è€…å‡ºé™¢æ“ä½œ - æ‰‹æœºç«¯åŠç†å‡ºé™¢ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰
- âœ… æ’¤é”€å‡ºé™¢åŠŸèƒ½ - ç®¡ç†ç«¯æ’¤é”€è¯¯æ“ä½œ

### è§„åˆ™å®šä¹‰
- **æ‚£è€…è¿‡æ»¤** - æ‰‹æœºç«¯åªæ˜¾ç¤ºåœ¨é™¢æ‚£è€…ï¼Œå·²å‡ºé™¢å®Œå…¨è¿‡æ»¤
- **å¿«æ·é¡¹ç›®ç¼“å­˜** - æ¯å¤©0ç‚¹è‡ªåŠ¨æ›´æ–°ï¼ŒæŸ¥è¯¢å‰7å¤©æ•°æ®
- **æ—¶é—´éªŒè¯** - éªŒè¯æ‚£è€…æ—¶é—´ï¼Œå…è®¸æ— ç¼è¡”æ¥ï¼Œå†²çªæ—¶è­¦å‘Š

---

## ğŸ“‹ æ¸è¿›å¼å¼€å‘è®¡åˆ’

---

## ğŸš€ ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘

**ç›®æ ‡ï¼š** å®ç°æ—¶é—´éªŒè¯å’Œå¿«æ·é¡¹ç›®ï¼Œè§£å†³æœ€é«˜é¢‘çš„ä½¿ç”¨ç—›ç‚¹

### 1.1 æ—¶é—´å†²çªéªŒè¯åŠŸèƒ½

#### åç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `backend/src/records/records.controller.ts`
```typescript
@Post('validate-time-conflict')
@ApiOperation({ summary: 'éªŒè¯æ²»ç–—æ—¶é—´å†²çª' })
async validateTimeConflict(@Body() data: any) {
  return this.recordsService.validateTimeConflict(data);
}
```

**æ–‡ä»¶ï¼š** `backend/src/records/records.service.ts`
```typescript
async validateTimeConflict(data: {
  patientId: number;
  startTime: string;  // ISOæ ¼å¼
  projectId?: number;
}) {
  const { patientId, startTime } = data;

  // 1. è·å–è¯¥æ‚£è€…æœ€è¿‘10æ¡æ²»ç–—è®°å½•
  const records = await this.prisma.treatmentRecord.findMany({
    where: { patientId },
    select: {
      id: true,
      startTime: true,
      endTime: true,
      project: {
        select: { name: true }
      },
      therapist: {
        select: { name: true }
      }
    },
    orderBy: {
      startTime: 'desc'
    },
    take: 10
  });

  // 2. æ£€æŸ¥æ—¶é—´å†²çª
  // è§„åˆ™ï¼šå…è®¸æ— ç¼è¡”æ¥ï¼ˆstartTime >= è®°å½•çš„endTimeï¼‰
  // å†²çªï¼šstartTime < è®°å½•çš„endTime
  const newStartTime = new Date(startTime);

  for (const record of records) {
    const recordStartTime = new Date(record.startTime);
    const recordEndTime = new Date(record.endTime);

    // æ£€æŸ¥å¼€å§‹æ—¶é—´æ˜¯å¦åœ¨ç°æœ‰è®°å½•çš„æ—¶é—´èŒƒå›´å†…
    if (newStartTime >= recordStartTime && newStartTime < recordEndTime) {
      // å‘ç°å†²çª
      return {
        hasConflict: true,
        conflictingRecord: {
          projectName: record.project.name,
          therapistName: record.therapist.name,
          startTime: recordStartTime.toISOString(),
          endTime: recordEndTime.toISOString()
        }
      };
    }
  }

  // æ— å†²çª
  return {
    hasConflict: false
  };
}
```

**éªŒè¯é€»è¾‘å›¾ï¼š**
```
æ–°è®°å½•å¼€å§‹æ—¶é—´ï¼š09:15

ç°æœ‰è®°å½•ï¼š
- 08:00 - 08:30  è¿åŠ¨è®­ç»ƒ
- 09:00 - 09:30  ç”Ÿæ´»è®­ç»ƒ  â† å†²çªï¼
- 10:00 - 10:30  è®¤çŸ¥è®­ç»ƒ

éªŒè¯ç»“æœï¼š
âŒ 09:15 åœ¨ 09:00-09:30 èŒƒå›´å†… â†’ æ‹’ç»
âœ… 09:30 >= 09:00-09:30 ç»“æŸæ—¶é—´ â†’ å…è®¸ï¼ˆæ— ç¼è¡”æ¥ï¼‰
```

#### æ‰‹æœºç«¯å‰ç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `mobile-frontend/src/pages/record/create.vue`

**åœ¨"å¼€å§‹æ²»ç–—"æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸­æ·»åŠ éªŒè¯ï¼š**
```typescript
async function handleStartTreatment() {
  // 1. è®°å½•å¼€å§‹æ—¶é—´
  startTime.value = new Date();

  // 2. è°ƒç”¨åç«¯éªŒè¯
  try {
    const result = await request.post('/records/validate-time-conflict', {
      patientId: selectedPatient.value.id,
      startTime: startTime.value.toISOString(),
      projectId: selectedProject.value.id
    });

    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
    if (result.hasConflict) {
      // æ˜¾ç¤ºå†²çªè­¦å‘Šå¼¹çª—
      showConflictDialog(result.conflictingRecord);
      return;
    }

    // 4. æ— å†²çªï¼Œç»§ç»­åŸæœ‰æµç¨‹
    isTreating.value = true;
    uni.showToast({
      title: 'å¼€å§‹æ²»ç–—',
      icon: 'success'
    });

  } catch (error) {
    uni.showToast({
      title: 'éªŒè¯å¤±è´¥',
      icon: 'error'
    });
  }
}

// æ˜¾ç¤ºå†²çªè­¦å‘Šå¼¹çª—
function showConflictDialog(conflict: any) {
  uni.showModal({
    title: 'âš ï¸ æ—¶é—´å†²çªè­¦å‘Š',
    content: `è¯¥æ‚£è€…åœ¨æ­¤æ—¶æ®µå·²æœ‰æ²»ç–—è®°å½•ï¼\n\n` +
              `å†²çªè®°å½•ï¼š\n` +
              `â€¢ é¡¹ç›®ï¼š${conflict.projectName}\n` +
              `â€¢ æ—¶é—´ï¼š${formatTime(conflict.startTime)} - ${formatTime(conflict.endTime)}\n` +
              `â€¢ æ²»ç–—å¸ˆï¼š${conflict.therapistName}\n\n` +
              `è¯·è°ƒæ•´æ—¶é—´åå†å¼€å§‹æ²»ç–—ã€‚`,
    showCancel: false,
    confirmText: 'æˆ‘çŸ¥é“äº†',
    success: () => {
      // é‡ç½®çŠ¶æ€
      startTime.value = null;
    }
  });
}

function formatTime(isoString: string): string {
  const date = new Date(isoString);
  return date.toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit'
  });
}
```

#### æµ‹è¯•ç”¨ä¾‹

| åœºæ™¯ | å¼€å§‹æ—¶é—´ | ç°æœ‰è®°å½• | é¢„æœŸç»“æœ |
|------|---------|---------|---------|
| æ— é‡å  | 10:00 | 09:00-09:30 | âœ… å…è®¸ |
| æ— ç¼è¡”æ¥ | 09:30 | 08:00-09:30 | âœ… å…è®¸ |
| å®Œå…¨é‡å  | 09:15 | 09:00-09:30 | âŒ æ‹’ç» |
| å¤šæ¡è®°å½• | 09:30 | 08:00-08:30, 10:00-10:30 | âœ… å…è®¸ |
| è¢«åŒ…å« | 08:50 | 08:30-09:30 | âŒ æ‹’ç»ï¼ˆä¼šé‡å ï¼‰|

---

### 1.2 å¿«æ·é¡¹ç›®åŠŸèƒ½

#### åç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `backend/src/projects/projects.controller.ts`
```typescript
@Get('recent')
@ApiOperation({ summary: 'è·å–æœ€è¿‘ä½¿ç”¨çš„é¡¹ç›®ï¼ˆå¿«æ·é¡¹ç›®ï¼‰' })
@ApiQuery({ name: 'days', required: false, example: '7' })
async getRecentProjects(
  @Query('days') days?: string,
  @CurrentUser() user: any
) {
  return this.projectsService.getRecentProjects(days, user);
}
```

**æ–‡ä»¶ï¼š** `backend/src/projects/projects.service.ts`
```typescript
async getRecentProjects(days: string = '7', user: any) {
  const daysNum = parseInt(days) || 7;
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - daysNum);

  // 1. è·å–å½“å‰ç”¨æˆ·æœ€è¿‘çš„æ²»ç–—è®°å½•
  const records = await this.prisma.treatmentRecord.findMany({
    where: {
      therapistId: user.id,
      treatmentDate: {
        gte: cutoffDate
      }
    },
    select: {
      project: true
    }
  });

  // 2. ç»Ÿè®¡æ¯ä¸ªé¡¹ç›®çš„ä½¿ç”¨æ¬¡æ•°
  const projectCountMap = new Map<number, {
    project: any;
    count: number;
    lastUsed: Date;
  }>();

  records.forEach((record) => {
    const projectId = record.project.id;
    if (!projectCountMap.has(projectId)) {
      projectCountMap.set(projectId, {
        project: record.project,
        count: 0,
        lastUsed: new Date(0)
      });
    }
    const item = projectCountMap.get(projectId)!;
    item.count++;
    if (item.project.createdAt) {
      item.lastUsed = new Date(Math.max(item.lastUsed.getTime(), item.project.createdAt));
    }
  });

  // 3. è½¬ä¸ºæ•°ç»„å¹¶æ’åº
  const sortedProjects = Array.from(projectCountMap.values())
    .sort((a, b) => b.count - a.count);

  // 4. è¿‡æ»¤ï¼šåªè¿”å›å½“å‰ç”¨æˆ·è§’è‰²æœ‰æƒé™çš„é¡¹ç›®
  const userProjects = await this.prisma.project.findMany({
    where: {
      isActive: true
    },
    select: {
      id: true,
      allowedRoles: true
    }
  });

  const allowedProjectIds = userProjects
    .filter(p => {
      const roles = JSON.parse(p.allowedRoles);
      return roles.includes(user.role);
    })
    .map(p => p.id);

  // 5. å–å‰3ä¸ª
  const recentProjects = sortedProjects
    .filter(item => allowedProjectIds.includes(item.project.id))
    .slice(0, 3)
    .map(item => ({
      projectId: item.project.id,
      projectName: item.project.name,
      count: item.count,
      lastUsed: item.lastUsed
    }));

  return {
    recentProjects,
    lastUpdated: new Date()  // ç”¨äºç¼“å­˜åˆ¤æ–­
  };
}
```

#### æ‰‹æœºç«¯å‰ç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `mobile-frontend/src/pages/record/create.vue`

**ç»„ä»¶ç»“æ„ï¼š**
```vue
<template>
  <view class="create-record">
    <!-- é€‰æ‹©æ‚£è€… -->
    <view class="patient-selector">
      <picker @change="onPatientChange">
        ...
      </picker>
    </view>

    <!-- é€‰æ‹©æ²»ç–—é¡¹ç›® -->
    <view class="project-selector">
      <view class="section-title">é€‰æ‹©æ²»ç–—é¡¹ç›®</view>

      <!-- ğŸ”¥ æœ€è¿‘ä½¿ç”¨ï¼ˆå¿«æ·æ–¹å¼ï¼‰ -->
      <view v-if="recentProjects.length > 0" class="recent-projects">
        <view class="recent-title">ğŸ”¥ æœ€è¿‘ä½¿ç”¨</view>
        <view
          v-for="project in recentProjects"
          :key="project.projectId"
          class="recent-item"
          :class="{ 'selected': selectedProject?.id === project.projectId }"
          @click="selectRecentProject(project)"
        >
          <text class="project-name">{{ project.projectName }}</text>
          <text class="project-count">{{ project.count }}æ¬¡</text>
        </view>
      </view>

      <!-- ğŸ“‹ å±•å¼€å…¨éƒ¨é¡¹ç›® -->
      <view class="all-projects">
        <view class="expand-header" @click="toggleProjects">
          <text>{{ showAllProjects ? 'ğŸ“‹ æ”¶èµ·é¡¹ç›®' : 'ğŸ“‹ å±•å¼€å…¨éƒ¨é¡¹ç›®' }}</text>
          <text class="expand-icon">{{ showAllProjects ? 'â–²' : 'â–¼' }}</text>
        </view>

        <view v-if="showAllProjects" class="project-list">
          <view
            v-for="project in allProjects"
            :key="project.id"
            class="project-item"
            :class="{ 'selected': selectedProject?.id === project.id }"
            @click="selectProject(project)"
          >
            <text class="project-name">{{ project.name }}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¼€å§‹æ²»ç–—æŒ‰é’® -->
    <button
      class="start-btn"
      :disabled="!selectedPatient || !selectedProject || isTreating"
      @click="handleStartTreatment"
    >
      {{ isTreating ? 'æ²»ç–—ä¸­...' : 'å¼€å§‹æ²»ç–—' }}
    </button>
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import request from '@/utils/request';

const recentProjects = ref([]);
const allProjects = ref([]);
const selectedProject = ref(null);
const showAllProjects = ref(false);
const isTreating = ref(false);

// ç¼“å­˜ç›¸å…³
const CACHE_KEY = 'recent_projects_cache';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24å°æ—¶

onMounted(() => {
  loadRecentProjects();
  loadAllProjects();
});

async function loadRecentProjects() {
  // æ£€æŸ¥ç¼“å­˜
  const cached = getCachedData();
  if (cached) {
    recentProjects.value = cached.recentProjects;
    console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œæ›´æ–°æ—¶é—´:', cached.lastUpdated);
    return;
  }

  // æ— ç¼“å­˜æˆ–å·²è¿‡æœŸï¼Œè¯·æ±‚åç«¯
  try {
    const result = await request.get('/projects/recent?days=7');
    recentProjects.value = result.recentProjects;

    // ä¿å­˜ç¼“å­˜
    setCachedData(result);
  } catch (error) {
    console.error('åŠ è½½å¿«æ·é¡¹ç›®å¤±è´¥:', error);
  }
}

function getCachedData() {
  try {
    const cached = uni.getStorageSync(CACHE_KEY);
    if (!cached) return null;

    const now = Date.now();
    if (now - cached.timestamp > CACHE_DURATION) {
      // ç¼“å­˜å·²è¿‡æœŸ
      uni.removeStorageSync(CACHE_KEY);
      return null;
    }

    return cached.data;
  } catch (error) {
    return null;
  }
}

function setCachedData(data: any) {
  try {
    uni.setStorageSync(CACHE_KEY, {
      data: data,
      timestamp: Date.now()
    });
  } catch (error) {
    console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', error);
  }
}

function selectRecentProject(project: any) {
  selectedProject.value = {
    id: project.projectId,
    name: project.projectName
  };
  showAllProjects.value = false;
}

function selectProject(project: any) {
  selectedProject.value = project;
}

function toggleProjects() {
  showAllProjects.value = !showAllProjects.value;
}
</script>

<style lang="scss" scoped>
.recent-projects {
  margin-bottom: 20px;

  .recent-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
  }

  .recent-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    margin-bottom: 10px;
    color: #fff;
    transition: all 0.2s;

    &.selected {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    &:active {
      transform: scale(0.98);
    }
  }
}

.expand-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f5f5f5;
  border-radius: 8px;
  margin-bottom: 10px;
}

.project-list {
  .project-item {
    padding: 12px 16px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 10px;

    &.selected {
      background: #e8f5e9;
      border-color: #4caf50;
    }
  }
}
</style>
```

#### ç¼“å­˜ç­–ç•¥

**æ›´æ–°æœºåˆ¶ï¼šæ¯å¤©0ç‚¹è‡ªåŠ¨æ›´æ–°**
```typescript
// ç”¨æˆ·æ‰“å¼€åº”ç”¨æ—¶æ£€æŸ¥
async function checkCacheUpdate() {
  const cached = getCachedData();
  if (!cached) {
    await loadRecentProjects();
    return;
  }

  const cachedDate = new Date(cached.timestamp);
  const today = new Date();

  // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€å¤©
  if (cachedDate.getDate() !== today.getDate() ||
      cachedDate.getMonth() !== today.getMonth() ||
      cachedDate.getFullYear() !== today.getFullYear()) {
    // æ–°çš„ä¸€å¤©ï¼Œé‡æ–°æŸ¥è¯¢
    console.log('æ–°çš„ä¸€å¤©ï¼Œæ›´æ–°å¿«æ·é¡¹ç›®');
    await loadRecentProjects();
  }
}
```

#### æµ‹è¯•ç”¨ä¾‹

| åœºæ™¯ | é¢„æœŸç»“æœ |
|------|---------|
| é¦–æ¬¡è¿›å…¥é¡µé¢ | è¯·æ±‚åç«¯APIï¼Œæ˜¾ç¤º3ä¸ªå¿«æ·é¡¹ç›® |
| åŒä¸€å¤©å†æ¬¡è¿›å…¥ | ä½¿ç”¨ç¼“å­˜ï¼Œä¸è¯·æ±‚åç«¯ |
| è·¨å¤©ï¼ˆç¬¬äºŒå¤©0ç‚¹åï¼‰ | ç¼“å­˜è¿‡æœŸï¼Œé‡æ–°è¯·æ±‚åç«¯ |
| æ‰‹åŠ¨åˆ·æ–° | é‡æ–°è¯·æ±‚åç«¯ï¼Œæ›´æ–°ç¼“å­˜ |
| å¿«æ·é¡¹ç›®ç‚¹å‡» | è‡ªåŠ¨é€‰ä¸­ï¼Œæ”¶èµ·å…¨éƒ¨é¡¹ç›® |
| å±•å¼€/æ”¶èµ· | åˆ‡æ¢æ˜¾ç¤ºå®Œæ•´é¡¹ç›®åˆ—è¡¨ |

---

## ğŸ¥ ç¬¬äºŒé˜¶æ®µï¼šæ‚£è€…ç®¡ç†åŠŸèƒ½

**ç›®æ ‡ï¼š** å®ç°æ–°å¢æ‚£è€…å’Œå‡ºé™¢æ“ä½œ

### 2.1 æ–°å¢æ‚£è€…åŠŸèƒ½

#### åç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `backend/src/patients/patients.service.ts`
```typescript
async create(data: any, creatorRole?: string) {
  // éªŒè¯ç—…å†å·æ ¼å¼
  const medicalRecordNo = data.medicalRecordNo;
  if (!/^\d{6}$/.test(medicalRecordNo)) {
    throw new BadRequestException('ç—…å†å·å¿…é¡»ä¸º6ä½æ•°å­—');
  }

  // æ£€æŸ¥ç—…å†å·å”¯ä¸€æ€§
  const existing = await this.prisma.patient.findFirst({
    where: { medicalRecordNo }
  });

  if (existing) {
    throw new BadRequestException('ç—…å†å·å·²å­˜åœ¨');
  }

  // åˆ›å»ºæ‚£è€…ï¼ˆé»˜è®¤ä¸éœ€è¦åº·å¤è¯„ä¼°ï¼‰
  return this.prisma.patient.create({
    data: {
      ...data,
      needsAssessment: data.needsAssessment ?? false,  // é»˜è®¤å…³é—­
      admissionDate: new Date(data.admissionDate),
      pinyin: data.pinyin || ''  // å¯é€‰ï¼šå‰ç«¯è‡ªåŠ¨ç”Ÿæˆ
    },
    include: {
      _count: {
        select: { treatmentRecords: true }
      }
    }
  });
}
```

#### æ‰‹æœºç«¯å‰ç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `mobile-frontend/src/pages/patient/create.vue`

**é¡µé¢ç»“æ„ï¼š**
```vue
<template>
  <view class="create-patient">
    <view class="header">
      <text class="title">æ–°å¢æ‚£è€…</text>
    </view>

    <form @submit.prevent="handleSubmit">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>

        <view class="form-item">
          <text class="label">å§“å *</text>
          <input
            v-model="formData.name"
            placeholder="è¯·è¾“å…¥æ‚£è€…å§“å"
            @input="handleNameChange"
          />
        </view>

        <view class="form-item">
          <text class="label">æ€§åˆ« *</text>
          <radio-group v-model="formData.gender">
            <label><radio value="ç”·" checked />ç”·</label>
            <label><radio value="å¥³" />å¥³</label>
          </radio-group>
        </view>

        <view class="form-item">
          <text class="label">å¹´é¾„ *</text>
          <input
            v-model="formData.age"
            type="number"
            placeholder="è¯·è¾“å…¥å¹´é¾„"
          />
        </view>

        <view class="form-item">
          <text class="label">ç—…å†å· *</text>
          <input
            v-model="formData.medicalRecordNo"
            type="text"
            maxlength="6"
            placeholder="è¯·è¾“å…¥6ä½æ•°å­—ç—…å†å·"
          />
        </view>

        <view class="form-item">
          <text class="label">åŒ»ä¿ç±»å‹ *</text>
          <picker
            :range="insuranceTypes"
            v-model="formData.insuranceType"
          >
            <view class="picker">
              {{ formData.insuranceType || 'è¯·é€‰æ‹©åŒ»ä¿ç±»å‹' }}
            </view>
          </picker>
        </view>

        <view class="form-item">
          <text class="label">ä¸»ç®¡åŒ»å¸ˆ *</text>
          <input
            v-model="formData.doctor"
            placeholder="è¯·è¾“å…¥ä¸»ç®¡åŒ»å¸ˆ"
          />
        </view>

        <view class="form-item">
          <text class="label">ä¸»è¦è¯Šæ–­ *</text>
          <textarea
            v-model="formData.diagnosis"
            placeholder="è¯·è¾“å…¥ä¸»è¦è¯Šæ–­"
            :maxlength="200"
          />
        </view>

        <view class="form-item">
          <text class="label">å…¥é™¢æ—¥æœŸ *</text>
          <picker
            mode="date"
            v-model="formData.admissionDate"
          >
            <view class="picker">
              {{ formData.admissionDate || 'è¯·é€‰æ‹©å…¥é™¢æ—¥æœŸ' }}
            </view>
          </picker>
        </view>

        <view class="form-item switch-item">
          <text class="label">éœ€è¦åº·å¤è¯„ä¼°</text>
          <switch
            :checked="formData.needsAssessment"
            @change="handleAssessmentChange"
            color="#409eff"
          />
          <text class="switch-desc">é»˜è®¤å…³é—­</text>
        </view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="button-group">
        <button class="btn-cancel" @click="handleCancel">å–æ¶ˆ</button>
        <button class="btn-submit" :disabled="submitting" @click="handleSubmit">
          {{ submitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
        </button>
      </view>
    </form>
  </view>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import request from '@/utils/request';
import { pinyin } from 'pinyin-pro';

const formData = ref({
  name: '',
  gender: 'ç”·',
  age: '',
  medicalRecordNo: '',
  insuranceType: '',
  doctor: '',
  diagnosis: '',
  admissionDate: '',
  needsAssessment: false
});

const submitting = ref(false);

const insuranceTypes = [
  'åŸé•‡èŒå·¥åŸºæœ¬åŒ»ç–—ä¿é™©',
  'åŸä¹¡å±…æ°‘åŸºæœ¬åŒ»ç–—ä¿é™©',
  'é“è·¯åŒ»ä¿',
  'å¼‚åœ°åŒ»ä¿',
  'è‡ªè´¹'
];

// å§“åå˜åŒ–æ—¶è‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³
function handleNameChange() {
  if (formData.value.name) {
    const result = pinyin(formData.value.name, {
      pattern: 'first',
      toneType: 'none'
    });
    formData.value.pinyin = result.toLowerCase().replace(/\s+/g, '');
  }
}

function handleAssessmentChange(e: any) {
  formData.value.needsAssessment = e.detail.value;
}

async function handleSubmit() {
  // éªŒè¯å¿…å¡«é¡¹
  if (!formData.value.name) {
    return uni.showToast({ title: 'è¯·è¾“å…¥å§“å', icon: 'none' });
  }
  if (!formData.value.medicalRecordNo) {
    return uni.showToast({ title: 'è¯·è¾“å…¥ç—…å†å·', icon: 'none' });
  }
  if (!/^\d{6}$/.test(formData.value.medicalRecordNo)) {
    return uni.showToast({ title: 'ç—…å†å·å¿…é¡»ä¸º6ä½æ•°å­—', icon: 'none' });
  }

  submitting.value = true;

  try {
    const result = await request.post('/patients', {
      ...formData.value,
      admissionDate: formData.value.admissionDate || new Date()
    });

    uni.showToast({
      title: 'ä¿å­˜æˆåŠŸ',
      icon: 'success'
    });

    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
    setTimeout(() => {
      // è·³è½¬åˆ°è¯¥æ‚£è€…çš„æ²»ç–—è®°å½•é¡µé¢
      uni.navigateTo({
        url: `/pages/record/create?patientId=${result.id}`
      });
    }, 1000);

  } catch (error: any) {
    uni.showToast({
      title: error.message || 'ä¿å­˜å¤±è´¥',
      icon: 'none'
    });
  } finally {
    submitting.value = false;
  }
}

function handleCancel() {
  uni.navigateBack();
}
</script>
```

---

### 2.2 æ‚£è€…å‡ºé™¢åŠŸèƒ½

#### åç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `backend/src/patients/patients.controller.ts`
```typescript
@Put(':id/discharge')
@ApiOperation({ summary: 'æ‚£è€…å‡ºé™¢' })
async discharge(
  @Param('id') id: string,
  @Body() data: { dischargeDate: string }
) {
  return this.patientsService.discharge(+id, data.dischargeDate);
}
```

**æ–‡ä»¶ï¼š** `backend/src/patients/patients.service.ts`
```typescript
async discharge(id: number, dischargeDateStr: string) {
  const patient = await this.prisma.patient.findUnique({
    where: { id }
  });

  if (!patient) {
    throw new NotFoundException('æ‚£è€…ä¸å­˜åœ¨');
  }

  if (patient.dischargeDate) {
    throw new BadRequestException('æ‚£è€…å·²å‡ºé™¢');
  }

  // æ›´æ–°å‡ºé™¢æ—¥æœŸ
  return this.prisma.patient.update({
    where: { id },
    data: {
      dischargeDate: new Date(dischargeDateStr)
    }
  });
}
```

#### æ‰‹æœºç«¯å‰ç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `mobile-frontend/src/pages/patient/detail.vue`

**å‡ºé™¢ç¡®è®¤æµç¨‹ï¼š**
```vue
<template>
  <view class="patient-detail">
    <!-- æ‚£è€…åŸºæœ¬ä¿¡æ¯ -->
    <view class="patient-info">
      <view class="info-row">
        <text class="label">å§“å</text>
        <text class="value">{{ patient.name }}</text>
      </view>
      <!-- ... å…¶ä»–ä¿¡æ¯ ... -->
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons" v-if="!patient.dischargeDate">
      <button class="btn-record" @click="goToRecord">
        æ²»ç–—è®°å½•
      </button>
      <button class="btn-discharge" @click="showDischargeDialog">
        å‡ºé™¢
      </button>
    </view>
  </view>
</template>

<script setup lang="ts">
function showDischargeDialog() {
  uni.showModal({
    title: 'âš ï¸  ç¡®è®¤å‡ºé™¢',
    content: `æ‚£è€…å§“åï¼š${patient.value.name}\nç—…å†å·ï¼š${patient.value.medicalRecordNo}\n\nå‡ºé™¢åå°†æ— æ³•ä¸ºè¯¥æ‚£è€…æ–°å¢æ²»ç–—è®°å½•ã€‚\n\nè¯·ç¡®è®¤å‡ºé™¢æ—¥æœŸã€‚`,
    editable: true,
    placeholderText: 'è¯·é€‰æ‹©å‡ºé™¢æ—¥æœŸ',
    success: (res) => {
      if (res.confirm) {
        handleDischarge(res.content);
      }
    }
  });
}

async function handleDischarge(dischargeDate?: string) {
  try {
    await request.put(`/patients/${patient.value.id}/discharge`, {
      dischargeDate: dischargeDate || new Date().toISOString().split('T')[0]
    });

    uni.showToast({
      title: 'å‡ºé™¢æˆåŠŸ',
      icon: 'success'
    });

    // åˆ·æ–°æ•°æ®
    await loadPatient();

  } catch (error: any) {
    uni.showToast({
      title: error.message || 'å‡ºé™¢å¤±è´¥',
      icon: 'none'
    });
  }
}
</script>
```

#### æ‚£è€…åˆ—è¡¨è¿‡æ»¤

**æ–‡ä»¶ï¼š** `mobile-frontend/src/pages/patient/list.vue`

```typescript
async function loadPatients() {
  try {
    const patients = await request.get('/patients');

    // è¿‡æ»¤å·²å‡ºé™¢æ‚£è€…
    activePatients.value = patients.filter((p: any) => !p.dischargeDate);

  } catch (error) {
    console.error('åŠ è½½æ‚£è€…åˆ—è¡¨å¤±è´¥:', error);
  }
}
```

---

## ğŸ”„ ç¬¬ä¸‰é˜¶æ®µï¼šç®¡ç†ç«¯ä¼˜åŒ–

**ç›®æ ‡ï¼š** ç®¡ç†ç«¯å¢åŠ æ’¤é”€å‡ºé™¢åŠŸèƒ½

### 3.1 æ’¤é”€å‡ºé™¢åŠŸèƒ½

#### åç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `backend/src/patients/patients.controller.ts`
```typescript
@Put(':id/revoke-discharge')
@ApiOperation({ summary: 'æ’¤é”€å‡ºé™¢' })
async revokeDischarge(@Param('id') id: string) {
  return this.patientsService.revokeDischarge(+id);
}
```

**æ–‡ä»¶ï¼š** `backend/src/patients/patients.service.ts`
```typescript
async revokeDischarge(id: number) {
  const patient = await this.prisma.patient.findUnique({
    where: { id }
  });

  if (!patient) {
    throw new NotFoundException('æ‚£è€…ä¸å­˜åœ¨');
  }

  if (!patient.dischargeDate) {
    throw new BadRequestException('æ‚£è€…æœªå‡ºé™¢ï¼Œæ— éœ€æ’¤é”€');
  }

  // æ¸…é™¤å‡ºé™¢æ—¥æœŸ
  return this.prisma.patient.update({
    where: { id },
    data: {
      dischargeDate: null
    }
  });
}
```

#### ç®¡ç†ç«¯å‰ç«¯å¼€å‘

**æ–‡ä»¶ï¼š** `web-admin/src/views/patients/Patients.vue`

**å·²å‡ºé™¢æ‚£è€…è¡¨æ ¼å¢åŠ æ“ä½œåˆ—ï¼š**
```vue
<el-table-column label="æ“ä½œ" width="150" fixed="right">
  <template #default="{ row }">
    <div class="action-buttons">
      <el-button
        type="primary"
        size="small"
        @click="handleViewRecords(row)"
      >
        æŸ¥çœ‹è®°å½•
      </el-button>
      <el-button
        type="warning"
        size="small"
        @click="handleRevokeDischarge(row)"
      >
        æ’¤é”€å‡ºé™¢
      </el-button>
    </div>
  </template>
</el-table-column>
```

**æ’¤é”€å‡ºé™¢ç¡®è®¤ï¼š**
```typescript
async function handleRevokeDischarge(row: any) {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦æ’¤é”€ ${row.name} çš„å‡ºé™¢çŠ¶æ€å—ï¼Ÿ`,
      'æ’¤é”€å‡ºé™¢',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    );

    await request.put(`/patients/${row.id}/revoke-discharge`);

    ElMessage.success('æ’¤é”€æˆåŠŸ');
    await loadData();

  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.message || 'æ’¤é”€å¤±è´¥');
    }
  }
}
```

---

## ğŸ“Š æµ‹è¯•è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µæµ‹è¯•

#### æ—¶é—´éªŒè¯æµ‹è¯•
- [ ] æ­£å¸¸æƒ…å†µï¼šæ— æ—¶é—´å†²çªï¼Œå¯ä»¥å¼€å§‹æ²»ç–—
- [ ] æ—¶é—´é‡å ï¼šæ˜¾ç¤ºè­¦å‘Šï¼Œé˜»æ­¢æ²»ç–—
- [ ] æ— ç¼è¡”æ¥ï¼š09:30å¼€å§‹ï¼ˆå‰ä¸€ä¸ª09:30ç»“æŸï¼‰å…è®¸
- [ ] è¾¹ç•Œæƒ…å†µï¼šè·¨å¤©è®°å½•å¤„ç†
- [ ] å¤šæ¡è®°å½•ï¼šæ£€æŸ¥æœ€è¿‘10æ¡å³å¯

#### å¿«æ·é¡¹ç›®æµ‹è¯•
- [ ] é¦–æ¬¡åŠ è½½ï¼šä»åç«¯è·å–
- [ ] ç¼“å­˜ç”Ÿæ•ˆï¼šåŒä¸€å¤©å†…å†æ¬¡è¿›å…¥ä½¿ç”¨ç¼“å­˜
- [ ] è·¨å¤©æ›´æ–°ï¼šç¬¬äºŒå¤©è‡ªåŠ¨åˆ·æ–°
- [ ] æƒé™è¿‡æ»¤ï¼šåªæ˜¾ç¤ºå½“å‰è§’è‰²æœ‰æƒé™çš„é¡¹ç›®
- [ ] æ’åºæ­£ç¡®ï¼šæŒ‰ä½¿ç”¨æ¬¡æ•°é™åº
- [ ] ç‚¹å‡»é€‰ä¸­ï¼šå¿«æ·é¡¹ç›®å¯ä»¥é€‰ä¸­
- [ ] å±•å¼€/æ”¶èµ·ï¼šå¯ä»¥æŸ¥çœ‹å…¨éƒ¨é¡¹ç›®

### ç¬¬äºŒé˜¶æ®µæµ‹è¯•

#### æ–°å¢æ‚£è€…æµ‹è¯•
- [ ] å¿…å¡«éªŒè¯ï¼šæ‰€æœ‰å¿…å¡«é¡¹éƒ½æ£€æŸ¥
- [ ] ç—…å†å·æ ¼å¼ï¼šå¿…é¡»6ä½æ•°å­—
- [ ] å”¯ä¸€æ€§æ£€æŸ¥ï¼šç—…å†å·ä¸èƒ½é‡å¤
- [ ] é»˜è®¤è®¾ç½®ï¼šè¯„ä¼°å¼€å…³é»˜è®¤å…³é—­
- [ ] ä¿å­˜è·³è½¬ï¼šæˆåŠŸåè·³è½¬æ²»ç–—è®°å½•é¡µ

#### å‡ºé™¢åŠŸèƒ½æµ‹è¯•
- [ ] å‡ºé™¢ç¡®è®¤ï¼šå¼¹å‡ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
- [ ] å‡ºé™¢æ—¥æœŸï¼šå¯ä»¥ä¿®æ”¹æ—¥æœŸ
- [ ] å‡ºé™¢æˆåŠŸï¼šä»æ‰‹æœºç«¯åˆ—è¡¨ç§»é™¤
- [ ] æŸ¥çœ‹è®°å½•ï¼šå·²å‡ºé™¢æ‚£è€…ä»å¯æŸ¥çœ‹å†å²è®°å½•

### ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•

#### æ’¤é”€å‡ºé™¢æµ‹è¯•
- [ ] æ’¤é”€ç¡®è®¤ï¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- [ ] æ’¤é”€æˆåŠŸï¼šæ¢å¤ä¸ºåœ¨é™¢çŠ¶æ€
- [ ] æ‰‹æœºç«¯åŒæ­¥ï¼šæ‚£è€…é‡æ–°å‡ºç°åœ¨æ‰‹æœºç«¯åˆ—è¡¨

---

## ğŸ“… å¼€å‘æ—¶é—´è¡¨

| é˜¶æ®µ | åŠŸèƒ½ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| **ç¬¬ä¸€é˜¶æ®µ** | | |
| åç«¯å¼€å‘ | æ—¶é—´éªŒè¯API | 0.5å¤© |
| åç«¯å¼€å‘ | å¿«æ·é¡¹ç›®API | 0.5å¤© |
| å‰ç«¯å¼€å‘ | æ—¶é—´éªŒè¯é›†æˆ | 1å¤© |
| å‰ç«¯å¼€å‘ | å¿«æ·é¡¹ç›®UI | 1å¤© |
| æµ‹è¯•è°ƒè¯• | ç¬¬ä¸€é˜¶æ®µæµ‹è¯• | 1å¤© |
| **å°è®¡** | | **3å¤©** |
| **ç¬¬äºŒé˜¶æ®µ** | | |
| åç«¯å¼€å‘ | æ–°å¢æ‚£è€…ä¼˜åŒ– | 0.5å¤© |
| åç«¯å¼€å‘ | å‡ºé™¢API | 0.5å¤© |
| å‰ç«¯å¼€å‘ | æ–°å¢æ‚£è€…é¡µé¢ | 1.5å¤© |
| å‰ç«¯å¼€å‘ | å‡ºé™¢åŠŸèƒ½ | 1å¤© |
| æµ‹è¯•è°ƒè¯• | ç¬¬äºŒé˜¶æ®µæµ‹è¯• | 1å¤© |
| **å°è®¡** | **4å¤©** |
| **ç¬¬ä¸‰é˜¶æ®µ** | | |
| åç«¯å¼€å‘ | æ’¤é”€å‡ºé™¢API | 0.5å¤© |
| å‰ç«¯å¼€å‘ | æ’¤é”€å‡ºé™¢æŒ‰é’® | 0.5å¤© |
| æµ‹è¯•è°ƒè¯• | å®Œæ•´æµ‹è¯• | 1å¤© |
| **å°è®¡** | **2å¤©** |
| **æ€»è®¡** | | **9å¤©** |

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- [x] æ—¶é—´å†²çªéªŒè¯å‡†ç¡®æ— è¯¯
- [x] å¿«æ·é¡¹ç›®ç¼“å­˜ç­–ç•¥æ­£å¸¸è¿è¡Œ
- [x] æ–°å¢æ‚£è€…æµç¨‹é¡ºç•…
- [x] å‡ºé™¢æ“ä½œæœ‰äºŒæ¬¡ç¡®è®¤
- [x] æ’¤é”€å‡ºé™¢åŠŸèƒ½æ­£å¸¸

### ç”¨æˆ·ä½“éªŒ
- [x] æ“ä½œæµç¨‹ç®€å•ç›´è§‚
- [x] é”™è¯¯æç¤ºæ¸…æ™°å‹å¥½
- [x] å“åº”é€Ÿåº¦å¿«ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
- [x] ç§»åŠ¨ç«¯ä½“éªŒæµç•…

### æ•°æ®å®‰å…¨
- [x] æ— æ—¶é—´å†²çªæ•°æ®
- [x] ç—…å†å·å”¯ä¸€æ€§ä¿è¯
- [x] å‡ºé™¢æ“ä½œæœ‰ç¡®è®¤æœºåˆ¶
- [x] å¯æ’¤é”€è¯¯æ“ä½œ

---

## ğŸ“ å¤‡æ³¨

1. **ä¸æ”¹å˜ç°æœ‰æµç¨‹**ï¼šæ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯åœ¨ç°æœ‰æµç¨‹åŸºç¡€ä¸Šå¢å¼ºï¼Œä¸æ”¹å˜åŸæœ‰çš„æ²»ç–—è®°å½•æµç¨‹
2. **å‘åå…¼å®¹**ï¼šæ‰€æœ‰æ–°APIéƒ½å…¼å®¹ç°æœ‰åŠŸèƒ½
3. **æ¸è¿›å¼ä¸Šçº¿**ï¼šæ¯ä¸ªé˜¶æ®µç‹¬ç«‹æµ‹è¯•å’Œä¸Šçº¿ï¼Œé™ä½é£é™©
4. **ç”¨æˆ·åŸ¹è®­**ï¼šæ–°åŠŸèƒ½ä¸Šçº¿å‰éœ€è¦ç®€å•åŸ¹è®­

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¶é—´ï¼š** 2026-01-16
**æœ€åæ›´æ–°ï¼š** 2026-01-16
