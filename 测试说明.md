# 三个阶段功能测试说明

## 测试环境准备

### 前提条件
1. 后端服务正在运行（http://localhost:3000）
2. 数据库已初始化并有种子数据
3. 管理员账号可用（username: admin, password: 123456）

## 测试脚本说明

项目提供了两个版本的测试脚本：

### 1. Node.js 版本（推荐，跨平台）

**文件：** `test-api.js`

**优点：**
- 跨平台（Windows/Linux/Mac）
- 更好的错误处理
- 详细的测试输出

**安装依赖：**
```bash
# 在项目根目录执行
npm install axios
```

**运行测试：**
```bash
node test-api.js
```

### 2. Bash 版本（Linux/Mac）

**文件：** `test-api.sh`

**运行测试：**
```bash
# 添加执行权限
chmod +x test-api.sh

# 运行测试
./test-api.sh
```

## 测试内容

### 测试数据准备
- ✅ 创建10个测试患者（TEST患者1-10）
- ✅ 每个患者50条治疗记录（总计500条）
- ✅ 记录时间跨度：最近50天
- ✅ 治疗时间：09:00-17:00，每30分钟一条

### 第一阶段测试（快捷项目 + 时间验证）
**测试1.1：** 查询快捷项目（最近7天）
- GET `/api/projects/recent?days=7`
- 验证返回最常用的3个项目
- 显示每个项目的使用次数

**测试1.2：** 时间冲突验证 - 无冲突情况
- POST `/api/records/validate-time-conflict`
- 使用未来时间（明天10:00）
- 预期结果：hasConflict: false

**测试1.3：** 时间冲突验证 - 有冲突情况
- POST `/api/records/validate-time-conflict`
- 使用历史时间（10天前10:00）
- 预期结果：hasConflict: true
- 显示冲突详情信息

**测试1.4：** 无缝衔接验证
- POST `/api/records/validate-time-conflict`
- 使用上一条记录的结束时间作为新开始时间
- 预期结果：hasConflict: false（允许无缝衔接）

### 第二阶段测试（新增患者 + 出院功能）
**测试2.1：** 新增患者（手机端场景）
- POST `/api/patients`
- 手动输入病历号：TESTNEW001
- 默认needsAssessment: false
- 验证患者创建成功

**测试2.2：** 手机端出院功能
- PATCH `/api/patients/:id/discharge`
- 自动设置出院日期为今天
- 验证出院成功

**测试2.3：** 验证出院后不在在院列表
- GET `/api/patients/today`
- 验证出院患者不在列表中

**测试2.4：** 验证出院日期已设置
- GET `/api/patients/:id`
- 验证dischargeDate字段已设置

### 第三阶段测试（撤销出院功能）
**测试3.1：** 撤销患者出院（Web后台）
- PUT `/api/patients/:id`
- 设置dischargeDate: null
- 验证撤销成功

**测试3.2：** 验证撤销后回到在院列表
- GET `/api/patients/today`
- 验证患者重新出现在列表中

**测试3.3：** 验证出院日期已清空
- GET `/api/patients/:id`
- 验证dischargeDate为null

**测试3.4：** 验证撤销后可以再次出院
- PATCH `/api/patients/:id/discharge`
- 验证可以再次设置出院日期

## 测试输出示例

```
============================================================
  虎林市中医医院康复科 - 三阶段功能全面测试
============================================================

============================================================
  1. 用户登录
============================================================

✓ 登录成功，Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

============================================================
  2. 清理旧测试数据
============================================================

✓ 清理了 15 个旧测试患者

============================================================
  3. 创建10个测试患者
============================================================

✓ 创建患者1: ID=123, 入院日期=2025-12-08
✓ 创建患者2: ID=124, 入院日期=2025-12-02
...

============================================================
  4. 创建治疗记录（每个患者50条）
============================================================

➤ 找到 7 个治疗项目
➤ 为患者1创建50条治疗记录...
  - 患者1记录10创建成功
  - 患者1记录20创建成功
...
✓ 患者1的50条记录创建完成

============================================================
  第一阶段测试：快捷项目 + 时间冲突验证
============================================================

➤ 测试1.1: 查询快捷项目（最近7天）
✓ 快捷项目查询成功，返回 3 个项目
  快捷项目列表：
    1. 运动功能训练 (使用25次)
    2. 针灸治疗 (使用18次)
    3. 电刺激治疗 (使用12次)

➤ 测试1.2: 时间冲突验证（无冲突 - 未来时间）
✓ 时间验证通过（无冲突）

➤ 测试1.3: 时间冲突验证（有冲突 - 使用历史时间）
✓ 时间冲突检测成功（发现冲突）
  冲突信息: 该患者在 2025-12-08 10:00 - 10:30 已有 运动功能训练 治疗...

➤ 测试1.4: 无缝衔接验证
✓ 无缝衔接验证通过（可以使用上一记录的结束时间）

✓ 第一阶段测试完成

============================================================
  第二阶段测试：新增患者 + 出院功能
============================================================

➤ 测试2.1: 新增患者（手机端场景）
✓ 新增患者成功，ID: 125

➤ 测试2.2: 手机端出院（PATCH /patients/:id/discharge）
✓ 患者出院成功

➤ 测试2.3: 验证出院患者不在在院列表
✓ 出院患者已从在院列表中移除

➤ 测试2.4: 验证患者出院日期已设置
✓ 患者出院日期已设置: 2026-01-17

✓ 第二阶段测试完成

============================================================
  第三阶段测试：撤销出院功能
============================================================

➤ 测试3.1: 撤销患者出院（PUT /patients/:id, dischargeDate: null）
✓ 撤销出院成功

➤ 测试3.2: 验证撤销后患者回到在院列表
✓ 撤销出院后患者已回到在院列表

➤ 测试3.3: 验证出院日期已清空
✓ 患者出院日期已清空

➤ 测试3.4: 验证撤销后可以再次出院
✓ 撤销后再次出院成功

✓ 第三阶段测试完成

============================================================
  测试结果统计
============================================================

数据库统计：
  - 总患者数：11
  - 在院患者数：10
  - 出院患者数：1
  - 治疗记录总数：500

✓ 数据统计完成

============================================================
测试全部完成！
✓ 所有功能测试通过！
```

## 预期测试结果

### 成功标准
- ✅ 所有API调用返回200状态码
- ✅ 10个测试患者创建成功
- ✅ 500条治疗记录创建成功
- ✅ 快捷项目查询返回3个项目
- ✅ 时间冲突验证正确检测冲突
- ✅ 无缝衔接验证通过
- ✅ 新增患者功能正常
- ✅ 出院功能正常
- ✅ 撤销出院功能正常

### 可能的问题和解决方案

**问题1：** 连接失败 `ECONNREFUSED`
- **原因：** 后端服务未启动
- **解决：** 启动后端服务 `cd backend && npm run start:dev`

**问题2：** 认证失败 401 Unauthorized
- **原因：** Token过期或密码错误
- **解决：** 检查admin账号密码是否为123456

**问题3：** 项目数量为0
- **原因：** 数据库没有种子数据
- **解决：** 运行 `npm run prisma:seed`

**问题4：** 创建记录失败
- **原因：** 患者ID不存在或项目ID不存在
- **解决：** 检查患者创建是否成功

## 清理测试数据

测试完成后，如需清理测试数据：

```bash
# 方法1: 使用测试脚本（会自动清理）
node test-api.js

# 方法2: 手动删除数据库
rm backend/data/database.db
cd backend && npm run prisma:migrate && npm run prisma:seed

# 方法3: 使用Web后台手动删除
访问 http://localhost:8080，进入患者管理，删除所有TEST开头的患者
```

## 测试覆盖率

### API端点测试覆盖
- ✅ POST /api/auth/login
- ✅ GET /api/patients
- ✅ POST /api/patients
- ✅ PUT /api/patients/:id
- ✅ PATCH /api/patients/:id/discharge
- ✅ GET /api/patients/today
- ✅ DELETE /api/patients/:id
- ✅ GET /api/projects
- ✅ GET /api/projects/recent
- ✅ POST /api/records
- ✅ GET /api/records
- ✅ POST /api/records/validate-time-conflict

### 功能测试覆盖
- ✅ 第一阶段：快捷项目查询
- ✅ 第一阶段：时间冲突验证（无冲突）
- ✅ 第一阶段：时间冲突验证（有冲突）
- ✅ 第一阶段：无缝衔接验证
- ✅ 第二阶段：新增患者
- ✅ 第二阶段：出院功能
- ✅ 第三阶段：撤销出院
- ✅ 第三阶段：撤销后再次出院

## 总结

本测试脚本全面覆盖了三个阶段的所有功能，包括：
1. 500条治疗记录的批量生成
2. 时间冲突验证的各种场景
3. 新增患者和出院的完整流程
4. 撤销出院的管理功能

通过此测试，可以验证：
- 所有API端点正常工作
- 业务逻辑正确实现
- 数据一致性得到保证
- 权限控制有效执行
