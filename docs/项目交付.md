# 虎林市中医医院康复科治疗记录系统 - 项目交付

## 📦 项目概述

本系统是一个完整的康复科治疗记录电子化管理系统，包括后端API、手机端和Web后台三个部分。

当前已完成**后端API开发**，包括完整的数据库设计、认证系统、用户管理、患者管理、治疗项目配置和治疗记录管理。

## 🎯 核心功能

### 1. 角色权限管理
- 医师（physician）：针灸治疗
- 护士（nurse）：电刺激治疗
- 治疗师（therapist）：运动功能训练、生活技能康复训练、认知功能训练、言语功能训练、职业功能康复训练
- 管理员（admin）：所有权限 + 用户管理

### 2. 智能搜索
- 病历号后3位快速定位（如输入"321"找到150321）
- 姓名拼音首字母筛选（如输入"wjg"找到"王建国"）
- 姓名和病历号模糊搜索

### 3. 极简记录流程
- 选患者 → 选项目 → 拍照 → 自动保存
- 自动计算结束时间（开始时间 + 默认时长 + 随机60-120秒）
- 自动生成照片文件名（病案号_序号.jpg）
- 患者反应默认"无不良反应"

### 4. 数据管理
- 患者管理：建档、编辑、查询、搜索
- 医护管理：新建用户、设置角色、修改密码、启用/禁用
- 治疗项目配置：可配置项目名称、时长、可操作角色
- 治疗记录管理：查看、编辑所有信息（患者、项目、时间、照片、反应、备注）

## 📁 项目结构

```
rehab-record-system/
├── backend/                    # 后端API (NestJS + SQLite)
│   ├── prisma/
│   │   ├── schema.prisma      # 数据库模型定义
│   │   └── seed.ts            # 种子数据（5个用户、7个项目、5个患者）
│   ├── src/
│   │   ├── auth/              # 认证模块（JWT + Passport）
│   │   ├── users/             # 用户管理模块
│   │   ├── patients/          # 患者管理模块
│   │   ├── projects/          # 治疗项目配置模块
│   │   ├── records/           # 治疗记录模块
│   │   ├── common/            # 公共模块（Prisma、守卫、装饰器）
│   │   ├── app.module.ts      # 主模块
│   │   └── main.ts            # 入口文件
│   ├── data/
│   │   └── database.db        # SQLite数据库文件（运行后生成）
│   ├── .env                   # 环境配置
│   ├── package.json           # 依赖配置
│   └── tsconfig.json          # TypeScript配置
│
├── mobile-frontend/           # 手机端 (uni-app) - 待开发
├── web-admin/                # Web后台 (Vue3) - 待开发
├── print-templates/          # 打印模板 - 待开发
│
├── demo.html                  # 交互演示页面（可用）
├── 项目计划.md                # 完整开发计划
├── API测试指南.md             # API测试文档
├── 开发进度.md                # 开发进度说明
└── README.md                  # 项目说明
```

## 🚀 快速开始

### 方式一：使用测试脚本（推荐）

双击运行 `test-api.bat`，脚本会自动：
1. 检查Node.js环境
2. 安装依赖（如果需要）
3. 生成Prisma客户端
4. 运行数据库迁移
5. 初始化种子数据
6. 启动开发服务器

### 方式二：手动启动

```bash
cd backend

# 安装依赖
npm install

# 生成Prisma客户端
npm run prisma:generate

# 运行数据库迁移
npx prisma migrate dev --name init

# 初始化种子数据
npm run prisma:seed

# 启动开发服务器
npm run start:dev
```

服务器启动后：
- API地址: http://localhost:3000
- Swagger文档: http://localhost:3000/api-docs

## 👤 测试账号

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 管理员 | admin | 123456 | 所有权限，可管理用户 |
| 医师 | doc001 | 123456 | 可做针灸治疗 |
| 护士 | nurse001 | 123456 | 可做电刺激治疗 |
| 治疗师 | therapist001 | 123456 | 可做各种康复训练 |
| 治疗师（禁用）| therapist002 | 123456 | 已禁用账号 |

## 🔑 核心API端点

### 认证
- `POST /auth/login` - 用户登录
- `GET /auth/profile` - 获取当前用户信息
- `POST /auth/logout` - 用户登出

### 用户管理（管理员）
- `GET /users` - 获取用户列表
- `POST /users` - 创建用户
- `PUT /users/:id` - 更新用户
- `DELETE /users/:id` - 删除用户
- `POST /users/:id/password` - 重置密码
- `POST /users/batch-reset-password` - 批量重置密码
- `PUT /users/:id/status` - 启用/禁用用户

### 患者管理
- `GET /patients` - 获取患者列表
- `GET /patients/search?q=xxx` - 搜索患者（病历号后3位或拼音首字母）
- `GET /patients/today` - 获取今日在院患者
- `GET /patients/:id` - 获取患者详情
- `POST /patients` - 创建患者
- `PUT /patients/:id` - 更新患者
- `DELETE /patients/:id` - 删除患者

### 治疗项目
- `GET /projects` - 获取所有项目
- `GET /projects/my` - 获取当前用户可操作的项目（根据角色过滤）
- `GET /projects/:id` - 获取项目详情
- `POST /projects` - 创建项目（管理员）
- `PUT /projects/:id` - 更新项目（管理员）
- `DELETE /projects/:id` - 删除项目（管理员）

### 治疗记录
- `GET /records` - 获取记录列表（可按患者、项目、治疗师、日期筛选）
- `GET /records/statistics` - 获取治疗统计
- `GET /records/:id` - 获取记录详情
- `POST /records` - 创建记录（自动计算结束时间和照片文件名）
- `PUT /records/:id` - 更新记录
- `DELETE /records/:id` - 删除记录（管理员）

## 💡 使用示例

### 1. 登录获取Token

```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"doc001","password":"123456"}'
```

### 2. 搜索患者（病历号后3位）

```bash
curl -X GET "http://localhost:3000/patients/search?q=321" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 获取当前用户可操作的项目

```bash
curl -X GET http://localhost:3000/projects/my \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. 创建治疗记录

```bash
curl -X POST http://localhost:3000/records \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "patientId": 1,
    "projectId": 1,
    "treatmentDate": "2024-01-10T14:30:00Z",
    "startTime": "2024-01-10T14:30:00Z"
  }'
```

系统会自动：
- 计算结束时间
- 生成照片文件名（150321_001.jpg）
- 设置默认患者反应（"无不良反应"）

## 📊 数据库结构

### 核心表
- **users** - 用户表（角色：physician/nurse/therapist/admin）
- **patients** - 患者表（含拼音首字母字段用于搜索）
- **projects** - 治疗项目表（allowedRoles存储JSON数组）
- **treatment_records** - 治疗记录表
- **assessments** - 康复评估表
- **treatment_photos** - 照片管理表

### 关键字段
- **Patient.pinyin** - 拼音首字母，如"wjg"（王建国）
- **Project.allowedRoles** - JSON数组，如["physician", "therapist"]
- **TreatmentRecord.extraSeconds** - 随机增加的秒数(60-120)
- **TreatmentRecord.photoFileName** - 自动生成，如"150321_001.jpg"

## 🎨 前端开发指南

### 手机端（uni-app）开发建议

1. **状态管理**：存储当前用户信息和角色
2. **搜索功能**：实时搜索，支持病历号后3位和拼音首字母
3. **角色过滤**：根据用户角色动态显示可操作项目
4. **时间计算**：在服务端完成，前端只展示结果
5. **拍照功能**：使用uni-app的相机API，添加时间水印

### Web后台（Vue3 + Element Plus）开发建议

1. **路由守卫**：检查用户权限
2. **侧边栏菜单**：根据角色动态显示
3. **仪表盘**：统计卡片（患者数、治疗人次、工作时长）
4. **表格**：使用el-table，支持筛选、排序、导出
5. **表单**：使用el-form，验证规则复用后端DTO

## 🔐 安全特性

- 密码使用bcrypt加密（salt rounds: 10）
- JWT令牌有效期7天
- 基于角色的访问控制（RBAC）
- 用户状态管理（启用/禁用）
- 输入验证（class-validator）
- SQL注入防护（Prisma ORM）

## 📝 待开发功能

### 前端
- [ ] 手机端（uni-app）
- [ ] Web后台（Vue3 + Element Plus）
- [ ] 打印模板

### 后端增强
- [ ] 照片上传接口
- [ ] 康复评估完整流程
- [ ] 统计报表增强
- [ ] 数据导出功能

## 🐛 已知问题

1. 数据库迁移可能需要手动执行（取决于Prisma版本）
2. 某些模块（assessments、photos、print、statistics）仅创建占位符

## 📞 技术支持

- API文档：http://localhost:3000/api-docs
- 数据库文件：`backend/data/database.db`
- 备份数据库：直接复制 `database.db` 文件

## 📄 许可证

Copyright © 2024 虎林市中医医院
