# 患者二维码功能设计文档

**创建日期:** 2025-01-18
**功能分支:** feature/qrcode
**设计目标:** 为患者管理添加二维码生成功能，支持打印、保存和移动端扫码治疗

---

## 一、功能概述

### 1.1 核心功能

**PC端 - 二维码生成：**
- 在"在院患者"列表操作栏添加"二维码"按钮
- 点击后弹出对话框，展示包含患者病历号的二维码
- 支持5种尺寸选择：1.5cm、2cm、3cm、4cm、5cm
- 提供下载PNG、复制到剪贴板、打印三种操作

**移动端 - 扫码治疗：**
- 扫描二维码后解析病历号参数
- 直接跳转到创建治疗记录页面
- 自动查询并填充患者信息

### 1.2 用户价值

- **效率提升：** 医护人员无需手动输入患者信息，扫码即可开始治疗记录
- **减少错误：** 避免手动输入病历号导致的错误
- **便捷打印：** 可随时打印患者二维码贴在病历或治疗单上

---

## 二、技术架构

### 2.1 技术选型

**前端：**
- **Vue 3 + TypeScript** - 组件开发
- **Element Plus** - UI组件库（对话框、按钮、单选框）
- **qrcode** (npm包) - 二维码生成库
- **Canvas API** - 图像渲染和文本添加

**后端：**
- 无需新增API，使用现有的患者查询接口

**移动端：**
- **uni-app** - 跨平台移动应用
- **路由参数传递** - 病历号传递

### 2.2 数据流

```
用户点击"二维码"按钮
  ↓
获取患者数据 (medicalRecordNo, name)
  ↓
生成二维码字符串: /create-record?medicalNo={病历号}
  ↓
渲染到Canvas (容错级别H, 附带患者姓名)
  ↓
用户选择尺寸 (1.5-5cm)
  ↓
用户操作:
  - 下载PNG: 患者姓名_病历号_qrcode.png
  - 复制到剪贴板: Clipboard API
  - 打印: window.print()
```

---

## 三、UI/UX设计

### 3.1 二维码对话框布局

```
┌─────────────────────────────────────┐
│  患者二维码                          │
├─────────────────────────────────────┤
│                                      │
│        ┌──────────────┐             │
│        │              │             │
│        │   二维码图    │             │
│        │              │             │
│        └──────────────┘             │
│           张三                      │
│                                      │
│  尺寸选择：○ 1.5cm ○ 2cm ● 3cm      │
│            ○ 4cm   ○ 5cm            │
│                                      │
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │下载  │ │复制  │ │打印  │        │
│  └──────┘ └──────┘ └──────┘        │
│                                      │
└─────────────────────────────────────┘
```

### 3.2 交互流程

1. **打开对话框：** 点击"二维码"按钮 → 对话框淡入
2. **选择尺寸：** 点击单选框 → 二维码重新生成（防抖200ms）
3. **下载：** 点击"下载"按钮 → 触发浏览器下载
4. **复制：** 点击"复制"按钮 → 复制到剪贴板 → 显示成功提示
5. **打印：** 点击"打印"按钮 → 浏览器打印对话框 → 选择打印机

### 3.3 响应式设计

- 对话框宽度：450px（固定）
- 二维码容器：居中显示
- 移动端适配：对话框宽度90vw

---

## 四、技术实现细节

### 4.1 二维码生成

**尺寸映射（cm转px，DPI=96）：**
```typescript
const SIZE_MAP = {
  '1.5cm': 57,   // 1.5 * 37.8
  '2cm': 76,     // 2 * 37.8
  '3cm': 113,    // 3 * 37.8
  '4cm': 151,    // 4 * 37.8
  '5cm': 189     // 5 * 37.8
}
```

**生成参数：**
- **容错级别：** H（约30%，最高）
- **边距：** 1
- **颜色：** 黑白
- **附加文本：** 患者姓名（二维码下方，居中）

**二维码内容格式：**
```
/create-record?medicalNo={病历号}
```

### 4.2 文件下载

**文件名格式：**
```
{患者姓名}_{病历号}_qrcode.png
例: 张三_2024001_qrcode.png
```

**实现方式：**
创建临时 `<a>` 标签，设置 `href` 和 `download` 属性，触发点击后移除。

### 4.3 复制到剪贴板

**技术方案：**
- 使用 `Clipboard API` (`navigator.clipboard.write`)
- 将 DataURL 转换为 Blob
- 创建 `ClipboardItem` 对象写入剪贴板

**降级处理：**
- 检测浏览器支持，不支持时提示使用下载功能
- 非 HTTPS 环境不支持 Clipboard API

### 4.4 打印功能

**实现方式：**
- 浏览器原生 `window.print()` API
- 使用 CSS `@media print` 控制打印样式

**打印样式：**
- 隐藏所有UI控件（按钮、单选框等）
- 只显示二维码和患者姓名
- 居中对齐，添加内边距
- 避免分页截断（`page-break-inside: avoid`）

---

## 五、移动端集成

### 5.1 路由配置

**路由定义：**
```typescript
{
  path: '/create-record',
  name: 'CreateRecord',
  component: () => import('@/views/CreateRecord.vue'),
  props: (route) => ({ medicalNo: route.query.medicalNo })
}
```

### 5.2 参数处理

**URL参数：**
- `medicalNo`: 病历号（字符串）

**页面逻辑：**
1. 从 `route.query` 获取 `medicalNo`
2. 调用后端API查询患者信息
3. 自动填充表单字段（患者ID、姓名）
4. 如果患者不存在，显示错误提示

**错误处理：**
- 病历号为空：提示"参数缺失"
- 患者不存在：提示"未找到该患者"
- 患者已出院：提示"该患者已出院，无法创建治疗记录"

### 5.3 基础URL配置

移动端需要配置基础URL，拼接完整访问地址：

```typescript
// 配置文件
const BASE_URL = {
  development: 'http://localhost:8080',
  production: 'https://yourdomain.com'
}

// 完整URL
const fullUrl = `${BASE_URL[env]}/create-record?medicalNo=${medicalNo}`
```

---

## 六、错误处理与边界情况

### 6.1 错误处理

**1. 二维码生成失败：**
- 捕获异常
- 显示错误提示："二维码生成失败，请重试"
- 记录错误日志到控制台

**2. 复制功能失败：**
- 检测 Clipboard API 支持
- 不支持时提示："当前浏览器不支持复制功能，请使用下载"
- 复制失败时提示："复制失败，请使用下载功能"

**3. 打印功能检测：**
- 检测 `window.print` 是否存在
- 不存在时提示："当前浏览器不支持打印功能"

### 6.2 边界情况

**1. 患者信息缺失：**
- 如果 `medicalRecordNo` 为空，禁用"二维码"按钮
- 显示 tooltip 提示："该患者病历号缺失"

**2. 并发操作：**
- 同一时间只生成一个二维码
- 生成中的按钮显示 loading 状态
- 使用防抖避免频繁重新生成（200ms）

**3. 内存管理：**
- 对话框关闭时清理 Canvas 对象
- 取消未完成的二维码生成请求
- 缓存已生成的二维码（Map: `${medicalNo}_${size}`）

**4. 打印预览：**
- 使用 CSS 确保只打印二维码区域
- 隐藏不需要的UI元素
- 添加打印前后的状态管理

---

## 七、测试策略

### 7.1 单元测试

**二维码生成函数：**
- 正确参数：成功生成二维码
- 错误参数：抛出异常
- 不同尺寸：验证尺寸计算准确性

**工具函数：**
- `getSizeInPx()`: 尺寸转换
- `generateFileName()`: 文件名生成
- `validateMedicalNo()`: 病历号验证

### 7.2 集成测试

**对话框交互：**
- 打开对话框：显示二维码和控件
- 切换尺寸：二维码重新生成
- 关闭对话框：清理资源

**功能测试：**
- 下载功能：文件正确保存
- 复制功能：剪贴板内容正确
- 打印功能：打印对话框弹出

### 7.3 跨浏览器测试

**桌面浏览器：**
- Chrome（推荐）
- Edge
- Firefox
- Safari

**移动端浏览器：**
- 微信内置浏览器
- 系统浏览器（Safari/Chrome）

### 7.4 移动端测试

**扫码测试：**
- 使用微信扫一扫
- 使用系统相机扫码
- 验证参数传递正确

**跳转测试：**
- 正确跳转到创建记录页面
- 患者信息自动填充
- 错误处理（患者不存在等）

---

## 八、性能优化

### 8.1 代码优化

**1. 懒加载：**
```typescript
// 按需导入 qrcode 库
const QRCode = await import('qrcode')
```

**2. 防抖处理：**
```typescript
import { debounce } from 'lodash-es'

const debouncedGenerate = debounce(generateQRCode, 200)
```

**3. Canvas缓存：**
```typescript
const qrCache = new Map<string, string>()

const cacheKey = `${medicalNo}_${size}`
if (qrCache.has(cacheKey)) {
  return qrCache.get(cacheKey)
}
```

### 8.2 内存优化

**1. 资源清理：**
- 对话框关闭时清理 Canvas
- 移除事件监听器
- 清空定时器

**2. 图片优化：**
- 使用 PNG 格式（无损压缩）
- 控制图片大小（最大5cm ≈ 189px）

### 8.3 用户体验优化

**1. 加载状态：**
- 生成中显示 loading 动画
- 禁用操作按钮

**2. 成功反馈：**
- 下载成功：提示"已下载"
- 复制成功：提示"已复制到剪贴板"
- 打印触发：无提示（浏览器处理）

**3. 快捷键支持：**
- `Esc`: 关闭对话框
- `Enter`: 触发默认操作（打印）

---

## 九、安全性考虑

### 9.1 数据安全

**1. 病历号保护：**
- 二维码只包含病历号，不包含敏感信息（姓名、年龄等）
- 移动端需验证权限才能访问患者信息

**2. 访问控制：**
- 只有登录用户才能生成二维码
- 移动端扫码后需验证登录状态

### 9.2 防滥用

**1. 频率限制：**
- 单个患者每分钟最多生成10次二维码
- 超过限制提示："操作过于频繁，请稍后再试"

**2. 参数校验：**
- 病历号格式校验（字母、数字、下划线）
- 参数长度限制（最长50字符）

---

## 十、部署与维护

### 10.1 部署清单

**前端依赖：**
- 安装 `qrcode` 包
- 安装 `@types/qrcode`（TypeScript类型定义）

**配置文件：**
- 移动端基础URL配置（开发/测试/生产环境）

**浏览器兼容性：**
- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14+

### 10.2 维护计划

**日志监控：**
- 记录二维码生成次数
- 记录错误类型和频率
- 监控性能指标（生成耗时）

**用户反馈：**
- 收集用户使用问题
- 优化常用操作流程
- 迭代改进功能

---

## 十一、后续优化方向

### 11.1 功能扩展

**1. 批量生成：**
- 支持一次性生成多个患者的二维码
- 生成PDF文件供打印

**2. 自定义样式：**
- 允许用户自定义二维码颜色
- 允许添加医院Logo

**3. 历史记录：**
- 记录已生成的二维码
- 支持重新下载历史二维码

### 11.2 技术改进

**1. 离线支持：**
- 使用 Service Worker 缓存二维码
- 支持离线查看和打印

**2. 性能提升：**
- 使用 Web Worker 生成二维码
- 预生成常用尺寸的二维码

---

## 十二、总结

本功能通过二维码技术连接PC端和移动端，简化了治疗记录创建流程，提升了医护人员的工作效率。技术实现简洁高效，不需要后端改动，易于维护和扩展。

**核心优势：**
- ✅ 无需后端改动，纯前端实现
- ✅ 使用成熟的二维码库，稳定可靠
- ✅ 跨平台支持（PC + 移动端）
- ✅ 用户体验流畅，功能完备

**预期收益：**
- 减少手动输入错误率 90%
- 治疗记录创建时间缩短 50%
- 提升医护人员满意度
