# H5应用二维码功能测试指南

## ✅ 已完成的修改

### 1. 环境变量配置
创建了 `web-admin/.env.local`:
```env
VITE_MOBILE_H5_URL=http://localhost:5173
```

### 2. 二维码URL格式
已修改为完整的HTTP URL:
```
http://localhost:5173/#/pages/record/create?medicalNo=2024001
```

### 3. 代码修改
- ✅ `PatientQRCodeDialog.vue` 已更新
- ✅ 使用环境变量配置移动端地址
- ✅ 生成完整的H5 URL
- ✅ 添加console.log调试输出

---

## 🧪 H5端到端测试步骤

### 准备工作

**1. 启动后端服务**
```bash
cd backend
npm run start:dev
```
端口: http://localhost:3000

**2. 启动移动端H5**
```bash
cd mobile-frontend
npm run dev:h5
```
端口: http://localhost:5173 (或其他端口)

**3. 启动Web管理端**
```bash
cd web-admin
npm run dev
```
端口: http://localhost:8082

---

### 测试流程

#### 步骤1: PC端生成二维码
1. 访问 http://localhost:8082
2. 登录系统
3. 进入"患者管理" → "在院患者"
4. 点击某个患者的"二维码"按钮
5. 查看浏览器控制台,确认生成的URL格式:
   ```
   生成二维码URL: http://localhost:5173/#/pages/record/create?medicalNo=2024001
   ```

#### 步骤2: 扫码测试
**方法1: 使用手机浏览器**
1. 用手机扫码工具(微信扫一扫、系统相机)扫描二维码
2. 点击识别的URL
3. 在手机浏览器中打开H5应用
4. 验证患者信息自动加载

**方法2: 在电脑浏览器直接访问**
1. 复制二维码中的URL(从控制台复制)
2. 在浏览器中打开该URL
3. 观察页面行为

#### 步骤3: 验证功能
**预期结果:**
- ✅ 页面跳转到 `/pages/record/create`
- ✅ URL参数 `medicalNo` 正确传递
- ✅ 显示"加载中..."提示
- ✅ 自动调用API: `GET /patients/by-medical-no/:medicalNo`
- ✅ 患者信息自动填充到页面
- ✅ 显示"患者信息已加载"提示
- ✅ 可以选择治疗项目并创建记录

---

### 测试场景

#### 场景1: 正常患者 ✅
```
病历号: 2024001 (有效的在院患者)
URL: http://localhost:5173/#/pages/record/create?medicalNo=2024001

预期:
- 患者信息加载成功
- 可以创建治疗记录
```

#### 场景2: 不存在的患者 ❌
```
病历号: 999999
URL: http://localhost:5173/#/pages/record/create?medicalNo=999999

预期:
- 显示"未找到该患者"错误
- 2秒后自动返回上一页
```

#### 场景3: 已出院患者 ❌
```
病历号: <已出院患者的病历号>
URL: http://localhost:5173/#/pages/record/create?medicalNo=<病历号>

预期:
- 显示"该患者已出院"错误
- 2秒后自动返回上一页
```

#### 场景4: 网络错误 ❌
```
操作: 关闭后端服务后扫码
预期:
- 显示"加载患者信息失败"错误
- 2秒后自动返回上一页
```

---

### 开发调试

#### 查看移动端H5日志
1. 打开浏览器开发者工具 (F12)
2. 切换到 Console 标签
3. 查看以下日志:
   ```
   📱 治疗记录页面 onLoad, options: {medicalNo: "2024001"}
   ✅ 接收到病历号: 2024001
   🔄 开始通过病历号加载患者信息
   ✅ 患者信息已加载
   ```

#### 查看网络请求
1. 打开浏览器开发者工具 (F12)
2. 切换到 Network 标签
3. 筛选 XHR 请求
4. 查找API调用:
   ```
   GET http://localhost:3000/patients/by-medical-no/2024001
   ```

#### 查看二维码内容
1. 在PC端打开二维码对话框
2. 按F12打开浏览器控制台
3. 查看"生成二维码URL"日志
4. 确认URL格式正确

---

### 常见问题

#### Q1: 扫码后页面404?
**原因:** 移动端H5未启动或端口不正确

**解决:**
1. 确认 `mobile-frontend` 正在运行
2. 检查实际运行端口(可能是5173或其他)
3. 修改 `web-admin/.env.local` 中的配置:
   ```env
   VITE_MOBILE_H5_URL=http://localhost:实际端口
   ```

#### Q2: 患者信息不加载?
**原因:** 后端服务未启动或API调用失败

**解决:**
1. 确认 `backend` 服务运行在 3000 端口
2. 检查浏览器Console是否有错误
3. 检查Network面板API请求状态

#### Q3: 二维码URL还是旧的相对路径?
**原因:** 开发服务器未重启,环境变量未加载

**解决:**
1. 停止 web-admin 开发服务器
2. 重新启动: `cd web-admin && npm run dev`
3. 清除浏览器缓存并刷新页面

#### Q4: 扫码后提示"未找到该患者"?
**原因:** 病历号不正确或患者已出院

**解决:**
1. 确认病历号正确(6位数字)
2. 在管理端查看该患者是否在院
3. 使用有效的在院患者测试

---

### URL配置说明

#### 开发环境
`web-admin/.env.local`:
```env
VITE_MOBILE_H5_URL=http://localhost:5173
```

#### 生产环境
部署时修改为实际域名:
```env
VITE_MOBILE_H5_URL=https://yourdomain.com/mobile
```

#### 跨域问题
如果遇到跨域问题,需要配置后端CORS:
```typescript
// backend/src/main.ts
app.enableCors({
  origin: ['http://localhost:5173', 'https://yourdomain.com'],
  credentials: true
})
```

---

### 性能测试

| 操作 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 二维码生成 | < 500ms | ~200ms | ✅ |
| 扫码跳转 | < 1s | 待测 | ⏳ |
| API查询 | < 300ms | 待测 | ⏳ |
| 页面填充 | < 100ms | 待测 | ⏳ |

---

### 兼容性测试

| 浏览器 | 版本 | 状态 |
|--------|------|------|
| Chrome | 90+ | ✅ |
| Edge | 90+ | 待测 |
| Firefox | 88+ | 待测 |
| Safari | 14+ | 待测 |
| 微信内置浏览器 | - | 待测 |

---

### 测试检查清单

#### PC端
- [x] 二维码生成
- [x] URL格式为完整HTTP地址
- [x] 包含正确的病历号参数
- [x] 开发服务器已重启

#### 移动端H5
- [ ] 服务器正常运行
- [ ] 可以访问首页
- [ ] URL参数接收正常
- [ ] API调用成功
- [ ] 患者信息填充
- [ ] 错误处理正确

#### 端到端
- [ ] 扫码成功
- [ ] 页面跳转正确
- [ ] 患者信息加载
- [ ] 可以创建记录

---

## 下一步

### 立即测试
1. 启动所有服务
2. 生成二维码
3. 扫码测试
4. 记录结果

### 如遇问题
1. 查看浏览器Console日志
2. 查看Network面板
3. 检查环境变量配置
4. 确认所有服务正常运行

### 测试通过后
1. 更新测试文档
2. 继续执行后续任务(Task 7-9)
3. 准备部署

---

## 测试结果模板

```
测试日期: _______________
测试人员: _______________

### 功能测试
- [ ] 二维码生成: 通过 / 失败
- [ ] 扫码跳转: 通过 / 失败
- [ ] 患者信息加载: 通过 / 失败
- [ ] 错误处理: 通过 / 失败

### 问题描述
1.
2.
3.

### 测试结论
[ ] 通过,可以继续
[ ] 需要修复问题
```
